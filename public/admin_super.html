<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>超级控制台 - SVIP CINEMA</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
    :root {
        --bg-body: #050505;
        --card-bg: rgba(20, 20, 20, 0.9);
        --primary: #d4af37;
        --gold-gradient: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
        --text-color: #e0e0e0;
        --border: 1px solid rgba(212, 175, 55, 0.2);
    }
    
    * { box-sizing: border-box; }
    body { margin: 0; background: var(--bg-body); color: var(--text-color); font-family: 'Noto Sans SC', sans-serif; }
    
    /* 顶部导航 */
    .navbar {
        height: 70px; background: rgba(10,10,10,0.95); border-bottom: 1px solid rgba(212, 175, 55, 0.3);
        display: flex; justify-content: space-between; align-items: center; padding: 0 40px;
        position: sticky; top: 0; z-index: 100;
    }
    .brand { font-size: 1.4rem; font-weight: bold; background: var(--gold-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .nav-right span { margin-right: 20px; color: #888; }
    .logout-btn { background: #333; color: #fff; border: 1px solid #555; padding: 5px 15px; cursor: pointer; border-radius: 4px; transition: 0.3s; }
    .logout-btn:hover { border-color: var(--primary); color: var(--primary); }

    /* 主布局 */
    .container { max-width: 1400px; margin: 30px auto; padding: 0 20px; display: grid; grid-template-columns: 350px 1fr; gap: 30px; }
    
    .card { background: var(--card-bg); border: var(--border); border-radius: 12px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    h2 { margin-top: 0; color: var(--primary); font-size: 1.2rem; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 20px; }

    /* 表单控件 */
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; color: #aaa; font-size: 0.9rem; }
    input, select { width: 100%; height: 45px; background: #000; border: 1px solid #333; color: #fff; padding: 0 15px; border-radius: 6px; outline: none; transition: 0.3s; }
    input:focus, select:focus { border-color: var(--primary); }
    
    .btn { width: 100%; height: 45px; background: var(--primary); color: #000; font-weight: bold; border: none; border-radius: 6px; cursor: pointer; transition: 0.3s; }
    .btn:hover { filter: brightness(1.1); }
    .btn-danger { background: #8b0000; color: #fff; width: auto; height: 30px; font-size: 0.8rem; padding: 0 10px; }

    /* 激活码结果区 */
    .result-box {
        margin-top: 20px; background: #000; border: 1px dashed #444; padding: 15px;
        height: 200px; overflow-y: auto; color: #0f0; font-family: monospace; font-size: 0.9rem;
    }
    
    /* 表格 */
    table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    th { text-align: left; padding: 12px; color: #888; border-bottom: 1px solid #333; font-size: 0.9rem; }
    td { padding: 12px; border-bottom: 1px solid #222; font-size: 0.95rem; }
    tr:hover { background: rgba(255,255,255,0.03); }
    
    .status-active { color: #0f0; background: rgba(0,255,0,0.1); padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; }
    .status-expired { color: #f00; background: rgba(255,0,0,0.1); padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; }
    
    /* 响应式 */
    @media (max-width: 900px) { .container { grid-template-columns: 1fr; } }
</style>
</head>
<body>
<!-- 建议直接替换原 admin_super.html 的 <body> 内容或参考以下结构 -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <!-- ... 原有 Meta 和 CSS 保持，补充以下样式 ... -->
    <style>
        /* 新增：选项卡样式 */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .tab-btn { background: none; border: none; color: #888; padding: 10px 20px; cursor: pointer; font-size: 1rem; transition: 0.3s; }
        .tab-btn.active { color: var(--primary); border-bottom: 2px solid var(--primary); font-weight: bold; }
        
        /* 批量操作工具栏 */
        .toolbar { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 10px 15px; border-radius: 8px; margin-bottom: 15px; }
        
        /* 状态标签 */
        .badge { padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; }
        .bg-success { background: rgba(0,255,0,0.2); color: #0f0; }
        .bg-warning { background: rgba(255,165,0,0.2); color: #ffa500; }
        .bg-danger { background: rgba(255,0,0,0.2); color: #f44; }

        .hidden { display: none; }
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1a1a1a; border: 1px solid var(--primary); padding: 30px; z-index: 1000; border-radius: 12px; width: 400px; box-shadow: 0 0 50px #000; }
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index: 999; }
    </style>
</head>
<body>

<div class="navbar">
    <div class="brand"><i class="fas fa-user-shield"></i> SVIP 全能管理后台</div>
    <div class="nav-right">
        <span id="adminName">管理员</span>
        <button class="logout-btn" onclick="logout()">退出</button>
    </div>
</div>

<div class="container" style="display: block;"> <!-- 改为块级布局 -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('user-sec')">用户管理</button>
        <button class="tab-btn" onclick="switchTab('code-sec')">激活码管理</button>
        <button class="tab-btn" onclick="switchTab('captcha-sec')">验证码记录</button>
    </div>

    <!-- 1. 用户管理模块 -->
    <div id="user-sec" class="tab-content card">
        <div class="toolbar">
            <div>
                <button class="btn btn-danger" onclick="batchDeleteUsers()" style="width: auto;">批量删除</button>
            </div>
            <div style="display:flex; gap:10px;">
                <input type="text" id="userSearch" placeholder="搜索手机/邮箱..." style="width:200px; height:35px;">
                <button class="btn" style="width:60px; height:35px;" onclick="loadUsers()">搜索</button>
            </div>
        </div>
        <table>
            <thead>
                <tr>
                    <th><input type="checkbox" onclick="toggleSelectAll('user-cb', this)"></th>
                    <th>ID</th>
                    <th>账号信息</th>
                    <th>角色</th>
                    <th>状态</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="userTableBody"></tbody>
        </table>
    </div>

    <!-- 2. 激活码管理模块 -->
    <div id="code-sec" class="tab-content card hidden">
        <div style="display: grid; grid-template-columns: 300px 1fr; gap: 20px;">
            <div class="side-panel">
                <h2>生成激活码</h2>
                <select id="codeDuration" class="form-group" style="margin-bottom:10px;">
                    <option value="30">月卡 (30天)</option>
                    <option value="365">年卡 (365天)</option>
                    <option value="9999">永久卡</option>
                </select>
                <input type="number" id="codeCount" placeholder="生成数量" value="1" style="margin-bottom:10px;">
                <button class="btn" onclick="generateCodes()">批量生成</button>
            </div>
            <div>
                <div class="toolbar">
                    <span>激活码库</span>
                    <select id="codeFilter" onchange="loadCodes()" style="width: 120px; height: 30px;">
                        <option value="all">全部状态</option>
                        <option value="unused">未使用</option>
                        <option value="used">已使用</option>
                    </select>
                </div>
                <table style="font-size: 0.85rem;">
                    <thead>
                        <tr>
                            <th>激活码</th>
                            <th>时长(天)</th>
                            <th>状态</th>
                            <th>使用者</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="codeTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 3. 验证码日志 -->
    <div id="captcha-sec" class="tab-content card hidden">
        <h2>最新验证码 (查看用户未收到的验证码)</h2>
        <table>
            <thead>
                <tr><th>邮箱</th><th>验证码</th><th>生成时间</th></tr>
            </thead>
            <tbody id="captchaTableBody"></tbody>
        </table>
    </div>
</div>

<!-- 编辑用户弹窗 -->
<div id="editModal" class="modal hidden">
    <h3>编辑用户信息</h3>
    <input type="hidden" id="editUserId">
    <div class="form-group">
        <label>角色切换</label>
        <select id="editRole">
            <option value="user">普通用户</option>
            <option value="admin">管理员</option>
        </select>
    </div>
    <div class="form-group">
        <label>增加VIP天数</label>
        <input type="number" id="addDays" value="0">
    </div>
    <button class="btn" onclick="saveUserEdit()">保存修改</button>
    <button class="btn" style="background:#444; color:#fff; margin-top:10px;" onclick="closeModal()">取消</button>
</div>
<div id="overlay" class="overlay hidden" onclick="closeModal()"></div>

<script>
    const adminAccount = JSON.parse(localStorage.getItem('vip_user')).username;

    function switchTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.remove('hidden');
        event.target.classList.add('active');
        if(id === 'user-sec') loadUsers();
        if(id === 'code-sec') loadCodes();
        if(id === 'captcha-sec') loadCaptchas();
    }

    // --- 用户操作 ---
    async function loadUsers() {
        const search = document.getElementById('userSearch').value;
        const res = await fetch('/api/admin/users', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ adminUser: adminAccount, search })
        });
        const data = await res.json();
        document.getElementById('userTableBody').innerHTML = data.users.map(u => `
            <tr>
                <td><input type="checkbox" class="user-cb" value="${u.id}"></td>
                <td>${u.id}</td>
                <td>${u.username}<br><small>${u.email || ''}</small></td>
                <td>${u.role}</td>
                <td><span class="badge ${u.is_active ? 'bg-success' : 'bg-danger'}">${u.is_active ? 'VIP' : '普通'}</span></td>
                <td>
                    <button class="btn btn-danger" style="width:auto; padding:0 5px;" onclick="openEditModal(${JSON.stringify(u).replace(/"/g, '&quot;')})">编辑</button>
                    <button class="btn btn-danger" style="width:auto; padding:0 5px; background:#600;" onclick="deleteUser(${u.id})">删除</button>
                </td>
            </tr>
        `).join('');
    }

    // 批量删除
    async function batchDeleteUsers() {
        const ids = Array.from(document.querySelectorAll('.user-cb:checked')).map(cb => cb.value);
        if(ids.length === 0) return alert('请选择要删除的用户');
        if(!confirm(`确定要删除选中的 ${ids.length} 个用户吗？`)) return;
        
        const res = await fetch('/api/admin/users/batch_delete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ adminUser: adminAccount, ids })
        });
        if((await res.json()).success) loadUsers();
    }

    // --- 激活码管理 ---
    async function loadCodes() {
        const filter = document.getElementById('codeFilter').value;
        const res = await fetch('/api/admin/codes/list', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ adminUser: adminAccount, filter })
        });
        const data = await res.json();
        document.getElementById('codeTableBody').innerHTML = data.codes.map(c => `
            <tr>
                <td style="font-family:monospace">${c.code}</td>
                <td>${c.duration_days}</td>
                <td><span class="badge ${c.is_used ? 'bg-danger' : 'bg-success'}">${c.is_used ? '已使用' : '有效'}</span></td>
                <td>${c.used_by || '-'}</td>
                <td>
                    <button class="btn-danger" onclick="deleteCode(${c.id})">作废</button>
                </td>
            </tr>
        `).join('');
    }

    async function deleteCode(id) {
        if(!confirm('确定作废此激活码？')) return;
        await fetch('/api/admin/codes/delete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ adminUser: adminAccount, id })
        });
        loadCodes();
    }

    // 弹窗逻辑
    function openEditModal(user) {
        document.getElementById('editUserId').value = user.id;
        document.getElementById('editRole').value = user.role;
        document.getElementById('editModal').classList.remove('hidden');
        document.getElementById('overlay').classList.remove('hidden');
    }
    function closeModal() {
        document.getElementById('editModal').classList.add('hidden');
        document.getElementById('overlay').classList.add('hidden');
    }

    async function saveUserEdit() {
        const payload = {
            adminUser: adminAccount,
            targetId: document.getElementById('editUserId').value,
            newRole: document.getElementById('editRole').value,
            addDays: document.getElementById('addDays').value
        };
        await fetch('/api/admin/users/update', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        closeModal();
        loadUsers();
    }

    function toggleSelectAll(className, master) {
        document.querySelectorAll('.' + className).forEach(cb => cb.checked = master.checked);
    }

    window.onload = loadUsers;
</script>
</body>
</html>

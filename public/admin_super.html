<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>超级控制台 - SVIP CINEMA</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg-body: #050505; --card-bg: rgba(20, 20, 20, 0.9); --primary: #d4af37; --gold-gradient: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c); --text-color: #e0e0e0; --border: 1px solid rgba(212, 175, 55, 0.2); }
        * { box-sizing: border-box; }
        body { margin: 0; background: var(--bg-body); color: var(--text-color); font-family: 'Noto Sans SC', sans-serif; }
        .navbar { height: 70px; background: rgba(10,10,10,0.95); border-bottom: 1px solid rgba(212, 175, 55, 0.3); display: flex; justify-content: space-between; align-items: center; padding: 0 40px; position: sticky; top: 0; z-index: 100; }
        .brand { font-size: 1.4rem; font-weight: bold; background: var(--gold-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .logout-btn { background: #333; color: #fff; border: 1px solid #555; padding: 5px 15px; cursor: pointer; border-radius: 4px; }
        .container { max-width: 1300px; margin: 30px auto; padding: 0 20px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 1px solid #333; }
        .tab-btn { background: none; border: none; color: #888; padding: 12px 25px; cursor: pointer; font-size: 1rem; }
        .tab-btn.active { color: var(--primary); border-bottom: 2px solid var(--primary); font-weight: bold; }
        .card { background: var(--card-bg); border: var(--border); border-radius: 12px; padding: 25px; margin-bottom: 20px; }
        .toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #222; }
        .btn { padding: 8px 15px; border-radius: 4px; border: none; cursor: pointer; font-weight: bold; }
        .btn-primary { background: var(--primary); color: #000; }
        .btn-danger { background: #600; color: #fff; margin-left: 5px; }
        .badge { padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; }
        .bg-success { background: rgba(0,255,0,0.2); color: #0f0; }
        .bg-danger { background: rgba(255,0,0,0.2); color: #f44; }
        .hidden { display: none; }
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1a1a1a; border: 1px solid var(--primary); padding: 30px; z-index: 1000; border-radius: 12px; width: 400px; }
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index: 999; }
        input, select { background: #000; border: 1px solid #333; color: #fff; padding: 10px; border-radius: 4px; width: 100%; margin-bottom: 15px; }
    </style>
</head>
<body>

<div class="navbar">
    <div class="brand"><i class="fas fa-user-shield"></i> SVIP 全能管理后台</div>
    <div class="nav-right">
        <span id="adminName">管理员</span>
        <button class="logout-btn" onclick="logout()">退出</button>
    </div>
</div>

<div class="container">
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('user-sec')">用户管理</button>
        <button class="tab-btn" onclick="switchTab('code-sec')">激活码管理</button>
        <button class="tab-btn" onclick="switchTab('captcha-sec')">验证码记录</button>
    </div>

    <!-- 用户管理 -->
    <div id="user-sec" class="tab-content card">
        <div class="toolbar">
            <button class="btn btn-danger" onclick="batchDeleteUsers()">批量删除</button>
            <div style="display:flex; gap:10px;">
                <input type="text" id="userSearch" placeholder="搜索手机/邮箱..." style="width:200px; margin:0;">
                <button class="btn btn-primary" onclick="loadUsers()">搜索</button>
            </div>
        </div>
        <table>
            <thead>
                <tr>
                    <th><input type="checkbox" onclick="toggleSelectAll('user-cb', this)"></th>
                    <th>ID</th>
                    <th>账号信息</th>
                    <th>角色</th>
                    <th>状态</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="userTableBody"></tbody>
        </table>
    </div>

    <!-- 激活码管理 -->
    <div id="code-sec" class="tab-content card hidden">
        <div style="display: grid; grid-template-columns: 300px 1fr; gap: 20px;">
            <div style="background:rgba(255,255,255,0.03); padding:20px; border-radius:8px;">
                <h3 style="color:var(--primary); margin-top:0;">生成激活码</h3>
                <label>选择时长</label>
                <select id="codeDuration">
                    <option value="30">月卡 (30天)</option>
                    <option value="365">年卡 (365天)</option>
                    <option value="9999">永久卡</option>
                </select>
                <label>生成数量</label>
                <input type="number" id="codeCount" value="1">
                <button class="btn btn-primary" style="width:100%;" onclick="generateCodes()">立即生成</button>
            </div>
            <div>
                <div class="toolbar">
                    <span>激活码库</span>
                    <select id="codeFilter" onchange="loadCodes()" style="width: 120px; margin:0;">
                        <option value="all">全部状态</option>
                        <option value="unused">未使用</option>
                        <option value="used">已使用</option>
                    </select>
                </div>
                <table>
                    <thead>
                        <tr><th>激活码</th><th>时长</th><th>状态</th><th>使用者</th><th>操作</th></tr>
                    </thead>
                    <tbody id="codeTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 验证码记录 -->
    <div id="captcha-sec" class="tab-content card hidden">
        <h2>最新验证码 (查看用户未收到的验证码)</h2>
        <table>
            <thead>
                <tr><th>邮箱</th><th>验证码</th><th>生成时间</th></tr>
            </thead>
            <tbody id="captchaTableBody"></tbody>
        </table>
    </div>
</div>

<!-- 编辑用户弹窗 -->
<div id="editModal" class="modal hidden">
    <h3>编辑用户信息</h3>
    <input type="hidden" id="editUserId">
    <label>角色切换</label>
    <select id="editRole">
        <option value="user">普通用户</option>
        <option value="admin">管理员</option>
    </select>
    <label>增加VIP天数</label>
    <input type="number" id="addDays" value="0">
    <button class="btn btn-primary" style="width:100%;" onclick="saveUserEdit()">保存修改</button>
    <button class="btn" style="width:100%; background:#444; color:#fff; margin-top:10px;" onclick="closeModal()">取消</button>
</div>
<div id="overlay" class="overlay hidden" onclick="closeModal()"></div>

<script>
    const userSession = JSON.parse(localStorage.getItem('vip_user') || '{}');
    const adminAccount = userSession.username;

    if (!adminAccount || userSession.role !== 'admin') {
        window.location.href = 'login.html';
    }
    document.getElementById('adminName').innerText = adminAccount;

    function switchTab(id) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.remove('hidden');
        event.target.classList.add('active');
        if(id === 'user-sec') loadUsers();
        if(id === 'code-sec') loadCodes();
        if(id === 'captcha-sec') loadCaptchas();
    }

    async function loadUsers() {
        const search = document.getElementById('userSearch').value;
        const res = await fetch('/api/admin/users', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ adminUser: adminAccount, search })
        });
        const data = await res.json();
        if(data.success) {
            document.getElementById('userTableBody').innerHTML = data.users.map(u => `
                <tr>
                    <td><input type="checkbox" class="user-cb" value="${u.id}"></td>
                    <td>${u.id}</td>
                    <td>${u.username}<br><small>${u.email || ''}</small></td>
                    <td>${u.role}</td>
                    <td><span class="badge ${u.is_active ? 'bg-success' : 'bg-danger'}">${u.is_active ? 'VIP' : '普通'}</span></td>
                    <td>
                        <button class="btn btn-primary" style="padding:4px 8px;" onclick='openEditModal(${JSON.stringify(u)})'>编辑</button>
                        <button class="btn btn-danger" style="padding:4px 8px;" onclick="deleteUser(${u.id})">删除</button>
                    </td>
                </tr>
            `).join('');
        }
    }

    async function loadCodes() {
        const filter = document.getElementById('codeFilter').value;
        const res = await fetch('/api/admin/codes/list', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ adminUser: adminAccount, filter })
        });
        const data = await res.json();
        if(data.success) {
            document.getElementById('codeTableBody').innerHTML = data.codes.map(c => `
                <tr>
                    <td style="font-family:monospace">${c.code}</td>
                    <td>${c.duration_days}天</td>
                    <td><span class="badge ${c.is_used ? 'bg-danger' : 'bg-success'}">${c.is_used ? '已使用' : '有效'}</span></td>
                    <td>${c.used_by || '-'}</td>
                    <td><button class="btn btn-danger" style="padding:4px 8px;" onclick="deleteCode(${c.id})">作废</button></td>
                </tr>
            `).join('');
        }
    }

    async function loadCaptchas() {
        const res = await fetch('/api/admin/captchas', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ adminUser: adminAccount })
        });
        const data = await res.json();
        if(data.success) {
            document.getElementById('captchaTableBody').innerHTML = data.logs.map(log => `
                <tr>
                    <td>${log.email}</td>
                    <td style="color:var(--primary); font-weight:bold;">${log.code}</td>
                    <td>${new Date(log.create_time).toLocaleString()}</td>
                </tr>
            `).join('');
        }
    }

    async function generateCodes() {
        const count = document.getElementById('codeCount').value;
        const duration = document.getElementById('codeDuration').value;
        await fetch('/api/admin/generate', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ adminUser: adminAccount, count, duration })
        });
        alert('生成成功');
        loadCodes();
    }

    async function deleteUser(id) {
        if(!confirm('确定要删除该用户吗？')) return;
        await fetch('/api/admin/delete_user', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ adminUser: adminAccount, targetId: id })
        });
        loadUsers();
    }

    async function deleteCode(id) {
        if(!confirm('确定作废此激活码？')) return;
        await fetch('/api/admin/codes/delete', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ adminUser: adminAccount, id })
        });
        loadCodes();
    }

    function openEditModal(u) {
        document.getElementById('editUserId').value = u.id;
        document.getElementById('editRole').value = u.role;
        document.getElementById('editModal').classList.remove('hidden');
        document.getElementById('overlay').classList.remove('hidden');
    }
    function closeModal() {
        document.getElementById('editModal').classList.add('hidden');
        document.getElementById('overlay').classList.add('hidden');
    }

    async function saveUserEdit() {
        const payload = {
            adminUser: adminAccount,
            targetId: document.getElementById('editUserId').value,
            newRole: document.getElementById('editRole').value,
            addDays: document.getElementById('addDays').value
        };
        await fetch('/api/admin/users/update', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        closeModal();
        loadUsers();
    }

    function toggleSelectAll(className, master) {
        document.querySelectorAll('.' + className).forEach(cb => cb.checked = master.checked);
    }

    function logout() { localStorage.removeItem('vip_user'); window.location.href = 'login.html'; }

    window.onload = loadUsers;
</script>
</body>
</html>

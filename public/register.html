<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ä¼šå‘˜æ³¨å†Œ - é»‘é‡‘è‡³å°Šç‰ˆ</title>
<!-- å¼•å…¥å­—ä½“å’Œå›¾æ ‡ -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@500;700&family=Noto+Sans+SC:wght@300;400;500&display=swap" rel="stylesheet">

<style>
    /* --- æ ¸å¿ƒå˜é‡ (ä¸ä¸»é¡µä¿æŒä¸€è‡´) --- */
    :root {
        --bg-body: #050505;
        --primary: #d4af37;
        --gold-gradient: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
        --glass-bg: rgba(20, 20, 20, 0.85);
        --input-bg: rgba(0, 0, 0, 0.6);
    }

    * { box-sizing: border-box; }

    body {
        margin: 0; padding: 0;
        font-family: 'Noto Sans SC', sans-serif;
        background-color: var(--bg-body);
        /* ç»Ÿä¸€èƒŒæ™¯çº¹ç† */
        background-image: 
            radial-gradient(circle at 50% 0%, rgba(212, 175, 55, 0.15), transparent 50%),
            linear-gradient(0deg, #000 0%, #080808 100%);
        color: #fff;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        overflow-x: hidden;
    }

    /* æ³¨å†Œå¡ç‰‡å®¹å™¨ */
    .register-wrapper {
        width: 100%;
        max-width: 460px;
        padding: 40px 30px;
        margin: 20px;
        background: var(--glass-bg);
        backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(212, 175, 55, 0.3);
        border-radius: 12px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.9);
        position: relative;
        animation: fadeInUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    /* é¡¶éƒ¨é‡‘è‰²æµå…‰æ¡ */
    .register-wrapper::before {
        content: ''; position: absolute; top: 0; left: 0; right: 0; height: 2px;
        background: var(--gold-gradient);
        opacity: 0.8; border-radius: 12px 12px 0 0;
    }

    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
    }

    .header { text-align: center; margin-bottom: 30px; }
    
    .logo {
        font-family: 'Noto Serif SC', serif;
        font-size: 1.5rem;
        font-weight: 700;
        background: var(--gold-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        margin-bottom: 8px;
        letter-spacing: 2px;
        text-shadow: 0 2px 10px rgba(212, 175, 55, 0.1);
    }

    .subtitle { color: #666; font-size: 0.9rem; letter-spacing: 1px; }

    /* è¡¨å•æ§ä»¶ */
    .form-group { position: relative; margin-bottom: 20px; }
    
    .form-control {
        width: 100%; height: 50px;
        background: var(--input-bg);
        border: 1px solid rgba(255,255,255,0.15);
        border-radius: 4px;
        padding-left: 45px; padding-right: 15px;
        color: #fff; font-size: 1rem;
        transition: 0.3s;
    }
    
    .form-control:focus {
        border-color: var(--primary);
        background: #000;
        outline: none;
        box-shadow: 0 0 15px rgba(212, 175, 55, 0.2);
    }

    .input-icon {
        position: absolute; left: 15px; top: 50%;
        transform: translateY(-50%);
        color: #555; transition: 0.3s; font-size: 1.1rem;
    }

    .form-control:focus + .input-icon { color: var(--primary); }

    /* éªŒè¯ç ç»„åˆ */
    .code-wrapper { display: flex; gap: 10px; }
    
    .code-btn {
        width: 130px;
        background: transparent;
        border: 1px solid rgba(212, 175, 55, 0.5);
        color: var(--primary);
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.9rem;
        transition: 0.3s;
        font-family: 'Noto Sans SC', sans-serif;
    }
    .code-btn:hover:not(:disabled) {
        background: rgba(212, 175, 55, 0.1);
        border-color: var(--primary);
        box-shadow: 0 0 10px rgba(212, 175, 55, 0.1);
    }
    .code-btn:disabled { 
        border-color: #333; color: #555; cursor: not-allowed; 
    }

    /* æ³¨å†ŒæŒ‰é’® */
    .submit-btn {
        width: 100%; height: 50px;
        margin-top: 15px;
        border: none; border-radius: 4px;
        background: var(--gold-gradient);
        background-size: 200% auto;
        color: #1a1a1a; font-weight: 700; font-size: 1.1rem; letter-spacing: 2px;
        cursor: pointer; transition: 0.4s;
    }
    .submit-btn:hover {
        background-position: right center;
        color: #000;
        box-shadow: 0 5px 20px rgba(212, 175, 55, 0.3);
        transform: translateY(-1px);
    }

    /* åº•éƒ¨é“¾æ¥ */
    .footer { text-align: center; margin-top: 25px; font-size: 0.9rem; color: #666; border-top: 1px solid #222; padding-top: 20px;}
    .footer a { color: var(--primary); text-decoration: none; margin-left: 5px; transition: 0.3s; }
    .footer a:hover { text-decoration: underline; color: #fff; }

    /* æç¤ºæ¡† */
    .toast {
        position: fixed; top: 15%; left: 50%; transform: translateX(-50%);
        background: rgba(0,0,0,0.9); border: 1px solid var(--primary);
        color: var(--primary); padding: 12px 25px; border-radius: 50px;
        z-index: 2000; font-size: 0.9rem; display: none;
        box-shadow: 0 5px 20px rgba(0,0,0,0.5);
    }

    /* åŠ è½½å±‚ */
    .loading-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.92); z-index: 3000; display: none;
        flex-direction: column; align-items: center; justify-content: center;
    }
    .spinner {
        width: 40px; height: 40px;
        border: 3px solid rgba(212, 175, 55, 0.3);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 500px) {
        .register-wrapper { padding: 30px 20px; background: rgba(10,10,10,0.9); border:none; box-shadow: none; }
        .register-wrapper::before { display: none; }
    }
</style>
</head>
<body>

    <div class="register-wrapper">
        <div class="header">
            <div class="logo"><i class="fas fa-crown"></i> SVIP CINEMA</div>
            <div class="subtitle">æ³¨å†Œé»‘é‡‘ä¼šå‘˜ï¼Œå¼€å¯ 4K è§†ç•Œ</div>
        </div>

        <form id="regForm">
            <!-- æ‰‹æœºå· -->
            <div class="form-group">
                <input type="tel" class="form-control" id="phone" placeholder="æ‰‹æœºå·ç  (ä½œä¸ºç™»å½•è´¦å·)" required>
                <i class="fas fa-mobile-screen input-icon"></i>
            </div>

            <!-- é‚®ç®± -->
            <div class="form-group">
                <input type="email" class="form-control" id="email" placeholder="ç”µå­é‚®ç®± (ç”¨äºæ‰¾å›å¯†ç )" required>
                <i class="fas fa-envelope input-icon"></i>
            </div>

            <!-- éªŒè¯ç  -->
            <div class="form-group code-wrapper">
                <div style="position:relative; flex:1;">
                    <input type="text" class="form-control" id="code" placeholder="6ä½é‚®ç®±éªŒè¯ç " required>
                    <i class="fas fa-shield-alt input-icon"></i>
                </div>
                <button type="button" class="code-btn" id="codeBtn" onclick="sendCode()">è·å–éªŒè¯ç </button>
            </div>

            <!-- å¯†ç  -->
            <div class="form-group">
                <input type="password" class="form-control" id="pwd" placeholder="è®¾ç½®ç™»å½•å¯†ç " required>
                <i class="fas fa-lock input-icon"></i>
            </div>

            <!-- ç¡®è®¤å¯†ç  -->
            <div class="form-group">
                <input type="password" class="form-control" id="pwd2" placeholder="ç¡®è®¤ç™»å½•å¯†ç " required>
                <i class="fas fa-check-circle input-icon"></i>
            </div>

            <button type="submit" class="submit-btn">ç«‹å³æ³¨å†Œ</button>
        </form>

        <div class="footer">
            å·²æœ‰è´¦å·? <a href="login.html">ç«‹å³ç™»å½•</a>
        </div>
    </div>

    <!-- åŠ è½½å±‚ -->
    <div class="loading-overlay" id="loading">
        <div class="spinner"></div>
        <p style="color:var(--primary); margin-top:15px; letter-spacing:1px;">æ­£åœ¨å¤„ç†...</p>
    </div>
    <div id="toast" class="toast"></div>

    <!-- è„šæœ¬å¼•å…¥ -->
    <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/blueimp-md5/2.19.0/js/md5.min.js"></script>

    <script>
        // ================= é…ç½®ä¸­å¿ƒ =================
        // 1. EmailJS é…ç½® (è¯·å¡«å…¥ä½ çš„çœŸå®ID)
        const EMAIL_USER_ID = "ä½ çš„User_ID"; 
        const EMAIL_SERVICE_ID = "ä½ çš„Service_ID"; 
        const EMAIL_TEMPLATE_ID = "ä½ çš„Template_ID"; 

        // 2. æ•°æ®åº“æ¥å£ (ç›¸å¯¹è·¯å¾„ï¼Œè‡ªåŠ¨é€‚é…åŸŸå)
        const API_URL = "/api/mysql"; 
        // ===========================================

        emailjs.init(EMAIL_USER_ID);
        let isCountDown = false;

        // --- åŠŸèƒ½ï¼šå‘é€éªŒè¯ç  ---
        function sendCode() {
            const email = document.getElementById('email').value.trim();
            const phone = document.getElementById('phone').value.trim();
            const btn = document.getElementById('codeBtn');

            if(!email || !phone) { showToast('è¯·å…ˆè¾“å…¥æ‰‹æœºå·å’Œé‚®ç®±'); return; }
            if(isCountDown) return;

            showToast('æ­£åœ¨è¯·æ±‚éªŒè¯ç ...');

            // 1. æ£€æŸ¥é™åˆ¶
            fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    sql: "SELECT COUNT(*) as count FROM email_code_temp WHERE email=? AND DATE(create_time)=CURDATE(); SELECT * FROM email_code_temp WHERE email=? AND TIMESTAMPDIFF(MINUTE,create_time,NOW()) < 1",
                    params: [email, email]
                })
            })
            .then(r => r.json())
            .then(data => {
                const dayCount = data[0][0].count;
                const recent = data[1].length;

                if(recent > 0) { showToast('æ“ä½œå¤ªé¢‘ç¹ï¼Œè¯·ç¨å'); return; }
                if(dayCount >= 10) { showToast('ä»Šæ—¥é™é¢å·²æ»¡'); return; }

                // 2. å‘é€é‚®ä»¶
                const code = Math.floor(100000 + Math.random() * 900000);
                
                // å­˜å…¥æ•°æ®åº“
                fetch(API_URL, {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        sql: "INSERT INTO email_code_temp(email, code, create_time) VALUES(?, ?, NOW())",
                        params: [email, code]
                    })
                });

                // å‘é€é‚®ä»¶ (EmailJS)
                emailjs.send(EMAIL_SERVICE_ID, EMAIL_TEMPLATE_ID, {
                    to_email: email,
                    code: code
                }).then(() => {
                    showToast('éªŒè¯ç å·²å‘é€è‡³é‚®ç®±');
                    startTimer(btn);
                }).catch(err => {
                    console.error(err);
                    showToast('é‚®ä»¶å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®');
                });
            })
            .catch(err => {
                console.error(err);
                showToast('æ•°æ®åº“è¿æ¥å¤±è´¥');
            });
        }

        // --- åŠŸèƒ½ï¼šæ³¨å†Œæäº¤ ---
        document.getElementById('regForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const phone = document.getElementById('phone').value.trim();
            const email = document.getElementById('email').value.trim();
            const code = document.getElementById('code').value.trim();
            const pwd = document.getElementById('pwd').value;
            const pwd2 = document.getElementById('pwd2').value;

            if(pwd !== pwd2) { showToast('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´'); return; }

            document.getElementById('loading').style.display = 'flex';

            // 1. éªŒè¯éªŒè¯ç 
            fetch(API_URL, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    sql: "SELECT * FROM email_code_temp WHERE email=? AND code=? AND TIMESTAMPDIFF(MINUTE,create_time,NOW()) <= 5 ORDER BY id DESC LIMIT 1",
                    params: [email, code]
                })
            })
            .then(r => r.json())
            .then(data => {
                // å¤„ç†è¿”å›æ•°æ®æ ¼å¼å…¼å®¹æ€§
                const rows = (Array.isArray(data) && data[0] && Array.isArray(data[0])) ? data[0] : data;
                
                if(rows.length > 0) {
                    // 2. éªŒè¯é€šè¿‡ï¼Œå†™å…¥ç”¨æˆ·è¡¨
                    const hash = md5(pwd);
                    
                    fetch(API_URL, {
                        method: "POST",
                        headers: {"Content-Type": "application/json"},
                        body: JSON.stringify({
                            // username=phone, email=email
                            sql: "INSERT INTO users(username, email, password_hash, registration_date) VALUES(?, ?, ?, NOW())",
                            params: [phone, email, hash]
                        })
                    })
                    .then(() => {
                        document.getElementById('loading').style.display = 'none';
                        showToast('ğŸ‰ æ³¨å†ŒæˆåŠŸï¼å³å°†è·³è½¬...');
                        setTimeout(() => {
                            window.location.href = "login.html";
                        }, 1500);
                    })
                    .catch(err => {
                        document.getElementById('loading').style.display = 'none';
                        showToast('æ³¨å†Œå¤±è´¥ï¼šæ‰‹æœºæˆ–é‚®ç®±å·²å­˜åœ¨');
                    });
                } else {
                    document.getElementById('loading').style.display = 'none';
                    showToast('éªŒè¯ç é”™è¯¯æˆ–å·²å¤±æ•ˆ');
                }
            })
            .catch(err => {
                document.getElementById('loading').style.display = 'none';
                showToast('ç½‘ç»œé”™è¯¯');
            });
        });

        // --- å·¥å…·ï¼šå€’è®¡æ—¶ ---
        function startTimer(btn) {
            isCountDown = true;
            let sec = 60;
            btn.disabled = true;
            const timer = setInterval(() => {
                btn.innerText = `${sec}s åé‡å‘`;
                sec--;
                if(sec < 0) {
                    clearInterval(timer);
                    btn.innerText = 'è·å–éªŒè¯ç ';
                    btn.disabled = false;
                    isCountDown = false;
                }
            }, 1000);
        }

        // --- å·¥å…·ï¼šæç¤ºæ¡† ---
        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerHTML = `<i class="fas fa-info-circle"></i> ${msg}`;
            toast.style.display = 'block';
            toast.style.animation = 'fadeInDown 0.5s';
            
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }
        
        // åŠ¨æ€æ³¨å…¥åŠ¨ç”»æ ·å¼
        const s = document.createElement('style');
        s.innerHTML = `@keyframes fadeInDown { from {opacity:0; transform:translate(-50%, -20px);} to {opacity:1; transform:translate(-50%, 0);} }`;
        document.head.appendChild(s);
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>后台管理</title>
<style>
    body { background: #eee; font-family: sans-serif; padding: 20px; }
    .container { max-width: 800px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    h2 { border-bottom: 2px solid #333; padding-bottom: 10px; }
    .panel { background: #f9f9f9; padding: 15px; margin-bottom: 20px; border: 1px solid #ddd; }
    button { padding: 8px 15px; background: #333; color: #fff; border: none; cursor: pointer; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #f0f0f0; }
    .active { color: green; font-weight: bold; }
    .inactive { color: red; }
    .code-box { background: #222; color: #0f0; padding: 10px; font-family: monospace; margin-top: 10px; display: none; }
</style>
</head>
<body>
    <div class="container">
        <h2>超级管理员后台 <button onclick="logout()" style="float:right; font-size:12px;">退出</button></h2>
        
        <div class="panel">
            <h3>生成激活码</h3>
            <p>生成数量：<input type="number" id="count" value="1" style="width:50px;"></p>
            <button onclick="genCodes()">生成</button>
            <div id="newCodes" class="code-box"></div>
        </div>

        <div class="panel">
            <h3>用户列表</h3>
            <button onclick="loadUsers()">刷新列表</button>
            <table id="userTable">
                <thead><tr><th>ID</th><th>用户名</th><th>邮箱</th><th>状态</th><th>注册时间</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        const user = JSON.parse(localStorage.getItem('vip_user') || '{}');
        if(user.role !== 'admin') {
            document.body.innerHTML = '<h1>非管理员禁止访问</h1><a href="login.html">返回</a>';
        }

        async function genCodes() {
            const count = document.getElementById('count').value;
            const res = await fetch('/api/admin/generate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ adminUser: user.username, count })
            });
            const data = await res.json();
            if(data.success) {
                const box = document.getElementById('newCodes');
                box.style.display = 'block';
                box.innerHTML = data.codes.join('<br>');
            } else { alert(data.message || '失败'); }
        }

        async function loadUsers() {
            const res = await fetch('/api/admin/users', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ adminUser: user.username })
            });
            const data = await res.json();
            if(data.success) {
                const tbody = document.querySelector('#userTable tbody');
                tbody.innerHTML = data.users.map(u => `
                    <tr>
                        <td>${u.id}</td>
                        <td>${u.username}</td>
                        <td>${u.email}</td>
                        <td class="${u.is_active?'active':'inactive'}">${u.is_active?'已激活':'未激活'}</td>
                        <td>${new Date(u.registration_date).toLocaleString()}</td>
                    </tr>
                `).join('');
            }
        }
        
        function logout() { localStorage.clear(); location.href='login.html'; }
        
        loadUsers(); // 进页面加载
    </script>
</body>
</html>
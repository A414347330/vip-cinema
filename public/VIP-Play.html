<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIP 专属通道 - 沉浸式播放</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@500;700&family=Noto+Sans+SC:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        /* --- 核心变量 --- */
        :root {
            --bg-body: #000000;
            --primary: #d4af37;
            --gold-gradient: linear-gradient(135deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
        }

        ::-webkit-scrollbar { width: 0; height: 0; background: transparent; }
        html, body { scrollbar-width: none; -ms-overflow-style: none; }

        body {
            -webkit-user-select: none; user-select: none;
            font-family: 'Noto Sans SC', sans-serif;
            color: #fff; height: 100vh; overflow: hidden;
            margin: 0; padding: 0;
            background-color: var(--bg-body);
        }

        /* --- 全屏布局设定 --- */
        #vipInterface {
            display: none; /* JS控制显示 */
            width: 100%; height: 100%;
            position: relative;
        }

        .video-container {
            width: 100%; height: 100%;
            position: absolute; top: 0; left: 0;
            z-index: 1;
            background: #000;
        }

        #videoPlayer {
            width: 100%; height: 100%;
            border: none; display: none; /* 加载完成后显示 */
        }

        /* 视频加载前的背景占位 */
        .video-placeholder {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            background: #000; z-index: 0;
        }
        .placeholder-logo {
            font-size: 3rem; color: #333; margin-bottom: 20px;
        }

        /* --- 身份检测弹窗 (Status Modal) --- */
        .status-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 3000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            backdrop-filter: blur(10px);
            transition: opacity 0.8s ease;
        }

        .status-box {
            width: 340px; text-align: center;
            padding: 40px;
            border: 1px solid rgba(212, 175, 55, 0.3);
            background: linear-gradient(180deg, #111 0%, #050505 100%);
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.1);
            border-radius: 8px;
            position: relative;
        }
        
        /* 扫描线动画效果 */
        .status-box::after {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px;
            background: var(--primary);
            box-shadow: 0 0 15px var(--primary);
            animation: scan 2s infinite linear;
            opacity: 0.5;
        }

        @keyframes scan {
            0% { top: 0; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        .status-icon {
            font-size: 3.5rem; margin-bottom: 20px;
            background: var(--gold-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
        }

        .status-title {
            font-family: 'Noto Serif SC', serif; font-size: 1.4rem; color: #fff; margin-bottom: 5px;
            letter-spacing: 2px;
        }

        .user-detail-row {
            margin: 25px 0; border-top: 1px solid #222; border-bottom: 1px solid #222;
            padding: 15px 0;
        }

        .info-item {
            display: flex; justify-content: space-between; margin: 8px 0; font-size: 0.95rem;
        }
        .info-label { color: #666; }
        .info-val { color: var(--primary); font-family: monospace; font-size: 1.1rem; letter-spacing: 1px; }

        .status-msg {
            color: #4CAF50; font-size: 0.9rem; letter-spacing: 1px; font-weight: bold;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        
        .loading-spinner {
            width: 14px; height: 14px; border: 2px solid #4CAF50; border-top-color: transparent;
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- 激活弹窗 (未激活时显示) --- */
        .activate-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 5000; display: none;
            justify-content: center; align-items: center;
        }
        .activate-box {
            width: 320px; padding: 30px; text-align: center; border: 1px solid #333; border-radius: 8px;
        }
        .code-input {
            width: 100%; padding: 10px; margin: 15px 0; background: #111; border: 1px solid #444; color: #fff; text-align: center;
        }
        .activate-btn {
            width: 100%; padding: 10px; background: var(--primary); border: none; font-weight: bold; cursor: pointer;
        }

    </style>
    <script>
        let currentUser = null;

        // 初始化
        function initApp() {
            const userStr = localStorage.getItem('vip_user');
            
            // 1. 未登录 -> 跳转登录
            if (!userStr) {
                window.location.href = 'login.html'; 
                return;
            }

            currentUser = JSON.parse(userStr);
            const isActive = Number(currentUser.is_active) === 1;

            window.addEventListener('DOMContentLoaded', () => {
                if (isActive) {
                    // 已激活 -> 显示主界面，并启动检测流程
                    document.getElementById('vipInterface').style.display = 'block';
                    document.getElementById('activateModal').style.display = 'none';
                    
                    // 启动身份检测动画
                    startIdentityCheck();

                } else {
                    // 未激活 -> 显示激活框
                    document.getElementById('vipInterface').style.display = 'none';
                    document.getElementById('activateModal').style.display = 'flex';
                }
            });
        }

        // 核心流程：身份检测与进入播放
        function startIdentityCheck() {
            const statusModal = document.getElementById('statusModal');
            const msgEl = document.getElementById('statusMsg');
            
            // 1. 填充用户信息
            document.getElementById('infoLevel').innerText = isPermanentVip(currentUser.expire_time) ? '黑金至尊 SVIP' : '尊享 VIP 会员';
            document.getElementById('infoAccount').innerText = maskUsername(currentUser.username);
            
            // 2. 模拟检测过程
            setTimeout(() => {
                msgEl.innerHTML = '<div class="loading-spinner"></div> 正在连接云端节点...';
            }, 800);

            setTimeout(() => {
                msgEl.innerHTML = '<i class="fas fa-check-circle"></i> 权限验证通过，已进入专属播放通道';
                msgEl.style.color = '#4CAF50'; // 绿色
            }, 2000);

            // 3. 检测完成，隐藏弹窗并播放
            setTimeout(() => {
                statusModal.style.opacity = '0';
                setTimeout(() => {
                    statusModal.style.display = 'none'; // 完全移除
                    autoPlayVideo(); // 触发播放
                }, 800); // 等待淡出动画
            }, 3500);
        }

        // 自动播放逻辑
        function autoPlayVideo() {
            // 获取 URL 参数中的 v_url
            const urlParams = new URLSearchParams(window.location.search);
            const targetUrl = urlParams.get('v_url');
            
            // 如果没有传参，这里为了演示，可以设置一个默认提示或者不做动作
            // 实际使用时，你需要确保跳转到这个页面时带了 ?v_url=...
            
            const player = document.getElementById('videoPlayer');
            const placeholder = document.getElementById('videoPlaceholder');
            
            // 这里使用一个更稳定的接口，或者保持你原来的接口
            // 默认接口：https://jx.xmflv.com/?url=
            const api = "https://jx.xmflv.com/?url=";

            if (targetUrl) {
                player.src = api + targetUrl;
                player.style.display = 'block';
                placeholder.style.display = 'none';
                console.log("正在播放:", targetUrl);
            } else {
                // 如果没有检测到URL参数，给用户一个提示（可选）
                placeholder.innerHTML = '<h3 style="color:#666">等待视频信号输入...</h3><p style="color:#444; font-size:0.8rem">请从片库选择视频跳转</p>';
            }
        }

        // 辅助函数：脱敏账号
        function maskUsername(username) {
            const str = String(username ?? '');
            if (/^\d{11}$/.test(str)) {
                return str.replace(/^(\d{3})\d{4}(\d{4})$/, '$1****$2');
            }
            // 如果不是手机号，取前2后2，中间4个星
            if (str.length > 4) {
                return str.substring(0, 2) + "****" + str.substring(str.length - 2);
            }
            return str + "****";
        }

        function isPermanentVip(expireTime) {
            if (!expireTime) return false;
            const d = new Date(expireTime);
            const ms = d.getTime() - Date.now();
            return ms / 86400000 > 3650; // 大于10年视为永久
        }

        // 激活逻辑（保留以备未激活用户使用）
        async function submitActivation() {
            const code = document.getElementById('activationCode').value.trim();
            if (!code) return alert("请输入激活码");
            
            try {
                // 模拟激活请求 (请替换为你真实的 API)
                const res = await fetch('/api/activate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ username: currentUser.username, code: code })
                });
                const data = await res.json();
                if (data.success) {
                    alert('激活成功');
                    currentUser.is_active = 1;
                    localStorage.setItem('vip_user', JSON.stringify(currentUser));
                    location.reload();
                } else {
                    alert(data.message || '激活失败');
                }
            } catch (e) { alert('网络错误'); }
        }

        initApp();
    </script>
</head>
<body>

    <!-- 主界面容器 -->
    <div id="vipInterface">
        
        <!-- 1. 全屏播放区域 -->
        <div class="video-container">
            <div class="video-placeholder" id="videoPlaceholder">
                <div class="placeholder-logo"><i class="fas fa-crown"></i></div>
            </div>
            <iframe id="videoPlayer" allowfullscreen allow="autoplay; encrypted-media"></iframe>
        </div>

        <!-- 2. 身份检测弹窗 (进入时显示) -->
        <div id="statusModal" class="status-modal">
            <div class="status-box">
                <div class="status-icon"><i class="fas fa-shield-alt"></i></div>
                <div class="status-title">安全校验中</div>
                <div style="font-size:0.8rem; color:#666; margin-bottom:10px;">SECURE CONNECTION ESTABLISHED</div>
                
                <div class="user-detail-row">
                    <div class="info-item">
                        <span class="info-label">会员等级</span>
                        <span class="info-val" id="infoLevel">检测中...</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">账号信息</span>
                        <span class="info-val" id="infoAccount">****</span>
                    </div>
                </div>

                <div class="status-msg" id="statusMsg">
                    <div class="loading-spinner"></div> 正在获取授权...
                </div>
            </div>
        </div>

    </div>

    <!-- 3. 激活弹窗 (仅未激活用户可见) -->
    <div class="activate-modal" id="activateModal">
        <div class="activate-box">
            <h2 style="color:var(--primary); margin-bottom:10px;">会员未激活</h2>
            <p style="color:#888; font-size:0.9rem;">请输入激活码以解锁全屏播放权限</p>
            <input type="text" class="code-input" id="activationCode" placeholder="VIP-XXXX-XXXX">
            <button class="activate-btn" onclick="submitActivation()">立即激活</button>
        </div>
    </div>

</body>
</html>